# VPS AuroraQ Trading System - Production Dockerfile
FROM python:3.11-slim-bullseye

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="AuroraQ Trading System"
LABEL version="1.0.0"
LABEL description="VPS Optimized Trading System with Advanced Monitoring & Security"

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Seoul \
    PYTHONPATH=/app \
    TRADING_MODE=live \
    VPS_MEMORY_LIMIT=3G \
    ENABLE_UNIFIED_LOGGING=true \
    API_HOST=0.0.0.0 \
    API_PORT=8004

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    # ë¹Œë“œ ë„êµ¬
    gcc \
    g++ \
    make \
    # ì‹œìŠ¤í…œ ë„êµ¬
    curl \
    wget \
    git \
    htop \
    nano \
    # ë„¤íŠ¸ì›Œí¬ ë„êµ¬
    netcat-openbsd \
    telnet \
    # í”„ë¡œì„¸ìŠ¤ ëª¨ë‹ˆí„°ë§
    procps \
    # íƒ€ìž„ì¡´ ì„¤ì •
    tzdata \
    # SSL/TLS ì§€ì›
    ca-certificates \
    # ì •ë¦¬
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone

# ìž‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /app

# ë³´ì•ˆì„ ìœ„í•œ ì‹œìŠ¤í…œ ì‚¬ìš©ìž ìƒì„±
RUN useradd --create-home --shell /bin/bash --uid 1000 aurorauser && \
    chown -R aurorauser:aurorauser /app

# Python ì˜ì¡´ì„± íŒŒì¼ ë³µì‚¬ ë° ì„¤ì¹˜ (ë©€í‹°ìŠ¤í…Œì´ì§€ ìµœì í™”)
COPY requirements.txt ./
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± ë° ê¶Œí•œ ì„¤ì •
RUN mkdir -p \
    /app/logs/{raw,summary,training,tagged,debug,api,error,security,monitoring} \
    /app/data/{cache,backups,configs,reports} \
    /app/run \
    && chown -R aurorauser:aurorauser /app \
    && chmod +x /app/*.py \
    && chmod +x /app/scripts/*.sh 2>/dev/null || true

# í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN cat > /app/healthcheck.sh << 'EOF'
#!/bin/bash
# ì¢…í•© í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸
set -e

echo "ðŸ” AuroraQ ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ ì‹œìž‘..."

# API ì„œë²„ ìƒíƒœ í™•ì¸
if curl -f --connect-timeout 5 --max-time 10 http://localhost:8004/health > /dev/null 2>&1; then
    echo "âœ… API ì„œë²„ ì •ìƒ"
else
    echo "âŒ API ì„œë²„ ì‘ë‹µ ì—†ìŒ"
    exit 1
fi

# ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸ (3GB ì œí•œ)
MEMORY_MB=$(python3 -c "import psutil; print(int(psutil.Process().memory_info().rss / 1024 / 1024))")
if [ $MEMORY_MB -gt 3072 ]; then
    echo "âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì´ˆê³¼: ${MEMORY_MB}MB > 3072MB"
    exit 1
else
    echo "âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ìƒ: ${MEMORY_MB}MB"
fi

# í•µì‹¬ í”„ë¡œì„¸ìŠ¤ í™•ì¸
if pgrep -f "python.*api_system.py" > /dev/null; then
    echo "âœ… API ì‹œìŠ¤í…œ í”„ë¡œì„¸ìŠ¤ ì •ìƒ"
else
    echo "âŒ API ì‹œìŠ¤í…œ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
    exit 1
fi

echo "ðŸŽ‰ í—¬ìŠ¤ì²´í¬ ì™„ë£Œ - ëª¨ë“  ì‹œìŠ¤í…œ ì •ìƒ"
EOF

# ì‹œìž‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN cat > /app/start_system.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸš€ AuroraQ VPS ê³ ë„í™” ì‹œìŠ¤í…œ ì‹œìž‘..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“Š ì‹œìŠ¤í…œ ì •ë³´:"
echo "   - Trading Mode: ${TRADING_MODE:-live}"
echo "   - Memory Limit: ${VPS_MEMORY_LIMIT:-3G}"
echo "   - API Port: ${API_PORT:-8004}"
echo "   - Time Zone: ${TZ:-Asia/Seoul}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ë””ë ‰í† ë¦¬ ê¶Œí•œ ìž¬í™•ì¸
chmod -R 755 /app/logs /app/data

# ì‹œìŠ¤í…œ ê²€ì¦ ì‹¤í–‰
echo "ðŸ” ì‹œìŠ¤í…œ ì‚¬ì „ ê²€ì¦ ì¤‘..."
python system_validator.py --quick-check || {
    echo "âš ï¸ ì‹œìŠ¤í…œ ê²€ì¦ì—ì„œ ë¬¸ì œ ë°œê²¬ë¨ - ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤"
}

# ì„±ëŠ¥ ìµœì í™” ì‹¤í–‰
echo "âš¡ ì„±ëŠ¥ ìµœì í™” ì‹¤í–‰ ì¤‘..."
python -c "
from performance_optimizer import global_optimizer
result = global_optimizer.auto_optimize()
print(f'âœ… ìµœì í™” ì™„ë£Œ: {result}')
" || echo "âš ï¸ ì„±ëŠ¥ ìµœì í™” ì‹¤íŒ¨ - ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì§„í–‰"

# ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì‹œìž‘
echo "ðŸ“Š ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì‹œìž‘..."
python -c "
from monitoring_alert_system import start_monitoring
start_monitoring()
print('âœ… ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì‹œìž‘ë¨')
" &

# ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
echo "ðŸ” ë³´ì•ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™”..."
python -c "
from security_system import global_security
scan_result = global_security.run_security_scan()
print(f'âœ… ë³´ì•ˆ ì ìˆ˜: {scan_result[\"security_score\"]}/100')
" || echo "âš ï¸ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨"

# API ì„œë²„ ì‹œìž‘
echo "ðŸŒ API ì„œë²„ ì‹œìž‘..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
exec python api_system.py --mode server --host ${API_HOST:-0.0.0.0} --port ${API_PORT:-8004}
EOF

# ê¸´ê¸‰ ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN cat > /app/emergency_recovery.sh << 'EOF'
#!/bin/bash
echo "ðŸš¨ ê¸´ê¸‰ ë³µêµ¬ ëª¨ë“œ ì‹¤í–‰..."

# ë©”ëª¨ë¦¬ ì •ë¦¬
python -c "
from performance_optimizer import global_optimizer
result = global_optimizer.memory_manager.emergency_cleanup()
print(f'ë©”ëª¨ë¦¬ ì •ë¦¬ ì™„ë£Œ: {result}')
"

# ì—ëŸ¬ ë¤í”„ ìƒì„±
python -c "
from debug_system import global_debugger
dump_file = global_debugger.emergency_debug_dump()
print(f'ë””ë²„ê·¸ ë¤í”„ ìƒì„±: {dump_file}')
"

echo "âœ… ê¸´ê¸‰ ë³µêµ¬ ì™„ë£Œ"
EOF

# ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
RUN chmod +x /app/*.sh

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8004 8003

# ë³¼ë¥¨ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸
VOLUME ["/app/logs", "/app/data"]

# ì‚¬ìš©ìž ì „í™˜
USER aurorauser

# í—¬ìŠ¤ì²´í¬ ì„¤ì • (30ì´ˆ ê°„ê²©, 10ì´ˆ íƒ€ìž„ì•„ì›ƒ, 3íšŒ ìž¬ì‹œë„)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /app/healthcheck.sh

# ê¸°ë³¸ ì‹¤í–‰ ëª…ë ¹
CMD ["/app/start_system.sh"]